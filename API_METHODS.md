# Анализ всех методов API сервиса IntegramDD

## Обзор

Сервис IntegramDD представляет собой FastAPI приложение для управления объектами, терминами, реквизитами и видеопотоками. Ниже представлен полный список всех доступных методов API.

---

## 1. Health Check (Проверка работоспособности)

### GET /health
**Описание:** Проверяет работоспособность сервиса и соединение с базой данных.

**Ответ:**
```json
{
  "status": "ok",
  "db": "connected"
}
```

---

## 2. Terms (Термины/Метаданные)

### GET /{db_name}/terms
**Описание:** Получает список всех терминов из базы данных.

**Параметры:**
- `db_name` - имя базы данных (в пути)

**Ответ:** Список всех терминов

---

### GET /{db_name}/terms/{term_id}
**Описание:** Получает конкретный термин по ID.

**Параметры:**
- `db_name` - имя базы данных
- `term_id` - ID термина

**Ответ:** Данные термина (ID, значение, базовый тип)

---

### GET /{db_name}/metadata
**Описание:** Получает метаданные всех терминов.

**Параметры:**
- `db_name` - имя базы данных

**Ответ:** Список метаданных всех терминов

---

### GET /{db_name}/metadata/{term_id}
**Описание:** Получает метаданные конкретного термина по ID.

**Параметры:**
- `db_name` - имя базы данных
- `term_id` - ID термина

**Ответ:** Метаданные термина с атрибутами и модификаторами

---

### POST /{db_name}/terms
**Описание:** Создает новый термин или возвращает существующий.

**Параметры:**
- `db_name` - имя базы данных
- Тело запроса:
  - `val` - значение термина
  - `t` - базовый тип
  - `mods` - модификаторы (опционально)

**Ответ:** ID созданного/существующего термина

---

### PATCH /{db_name}/terms/{term_id}
**Описание:** Обновляет имя или базовый тип термина, управляет модификаторами.

**Параметры:**
- `db_name` - имя базы данных
- `term_id` - ID термина
- Тело запроса:
  - `val` - новое значение (опционально)
  - `t` - новый базовый тип (опционально)
  - дополнительные поля для модификаторов

**Ответ:** Обновленные данные термина

---

### DELETE /{db_name}/terms/{term_id}
**Описание:** Удаляет термин и все его дочерние элементы рекурсивно.

**Параметры:**
- `db_name` - имя базы данных
- `term_id` - ID термина

**Ответ:** ID удаленного термина и количество удаленных элементов

---

## 3. Objects (Объекты)

### POST /{db_name}/objects
**Описание:** Создает новый объект заданного типа термина с указанными атрибутами.

**Параметры:**
- `db_name` - имя базы данных
- Тело запроса:
  - `id` - ID типа термина
  - `up` - ID родителя
  - `attrs` - атрибуты объекта

**Ответ:** Метаданные созданного объекта

---

### PATCH /{db_name}/objects/{object_id}
**Описание:** Обновляет объект и его атрибуты.

**Параметры:**
- `db_name` - имя базы данных
- `object_id` - ID объекта
- Тело запроса: поля для обновления (формат t{id})

**Ответ:** Результат обновления с предупреждениями/ошибками

---

### DELETE /{db_name}/objects/{object_id}
**Описание:** Удаляет объект и его вложенные записи рекурсивно.

**Параметры:**
- `db_name` - имя базы данных
- `object_id` - ID объекта

**Ответ:** ID удаленного объекта

---

### GET /{db_name}/object/{object_id}
**Описание:** Получает конкретный объект и его реквизиты по ID.

**Параметры:**
- `db_name` - имя базы данных
- `object_id` - ID объекта

**Ответ:** Полные данные объекта включая все реквизиты

---

### GET /{db_name}/objects/{term_id}
**Описание:** Получает все объекты заданного типа термина с поддержкой фильтрации, пагинации.

**Параметры:**
- `db_name` - имя базы данных
- `term_id` - ID типа термина
- `up` - ID родителя (query параметр)
- `limit` - лимит записей (query параметр)
- `offset` - смещение (query параметр)
- дополнительные параметры фильтрации

**Ответ:** Структурированный список объектов с заголовками и данными

---

### POST /{db_name}/objects/graphql
**Описание:** Альтернатива GET-запросу для получения объектов через POST с телом запроса.

**Параметры:**
- `db_name` - имя базы данных
- Тело запроса:
  - `term_id` - ID типа термина
  - `up` - ID родителя
  - `limit` - лимит записей
  - `offset` - смещение
  - `filters` - объект с фильтрами

**Ответ:** Структурированный список объектов

---

## 4. Requisites (Реквизиты/Атрибуты)

### POST /{db_name}/requisites
**Описание:** Добавляет реквизит (атрибут) к указанному термину.

**Параметры:**
- `db_name` - имя базы данных
- Тело запроса:
  - `id` - ID термина
  - `t` - ID типа реквизита
  - дополнительные модификаторы (unique, notnull, alias)

**Ответ:** ID нового/существующего реквизита с предупреждениями

---

## 5. References (Ссылки)

### POST /{db_name}/references
**Описание:** Создает ссылку на термин (объект с val = NULL и t = term_id).

**Параметры:**
- `db_name` - имя базы данных
- Тело запроса:
  - `id` - ID термина

**Ответ:** ID созданной/существующей ссылки

---

## 6. Video Streaming (Видеопотоки)

### POST /video/connect
**Описание:** Подключается к видеоисточнику для дрона.

**Параметры:**
- Тело запроса:
  - `drone_id` - ID дрона
  - `source_url` - URL источника видео

**Ответ:** Статус подключения

---

### POST /video/disconnect/{drone_id}
**Описание:** Отключается от видеоисточника.

**Параметры:**
- `drone_id` - ID дрона (в пути)

**Ответ:** Статус отключения

---

### GET /video/info/{drone_id}
**Описание:** Получает информацию о видеопотоке.

**Параметры:**
- `drone_id` - ID дрона (в пути)

**Ответ:** Информация о потоке (разрешение, FPS, URL, количество кадров)

---

### GET /video/stream/{drone_id}
**Описание:** HTTP MJPEG видеопоток.

**Параметры:**
- `drone_id` - ID дрона (в пути)

**Ответ:** Потоковое видео в формате MJPEG

---

### WebSocket /video/stream/ws/{drone_id}
**Описание:** WebSocket видеопоток.

**Параметры:**
- `drone_id` - ID дрона (в пути)

**Ответ:** Бинарные данные JPEG кадров через WebSocket

---

## Аутентификация

Большинство методов требуют аутентификации через Bearer токен в заголовке Authorization.

**Тестовый токен:** `secret-token`

---

## Документация API

После запуска сервиса интерактивная документация доступна по адресу:
- **Swagger UI:** http://localhost:8000/docs
- **ReDoc:** http://localhost:8000/redoc

---

## Итого

Сервис предоставляет **23 метода API**, разделенных на 6 основных категорий:

1. **Health Check** - 1 метод
2. **Terms** - 7 методов (CRUD операции с терминами и метаданными)
3. **Objects** - 6 методов (CRUD операции с объектами)
4. **Requisites** - 1 метод (добавление атрибутов)
5. **References** - 1 метод (создание ссылок)
6. **Video Streaming** - 7 методов (управление видеопотоками от дронов)

Все методы работают с динамическими таблицами базы данных (параметр `db_name`), что позволяет использовать один сервис для работы с множеством различных схем данных.
